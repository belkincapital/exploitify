<?php   

/* Admin menu */
function exploitify_menu() {
    add_submenu_page( 'options-general.php', 'Exploitify', 'Exploitify', 'manage_options', 'exploitify', 'exploitify_panel' );    
}

/* Checkboxes */
function exploitify_is_checked($par){
    if (isset($_POST["exploitify_fs"])) { if(isset($_POST[$par])) $k='checked';else $k=''; update_option($par,$k);} 
}

/* Inputs */
function exploitify_string_setting($par,$def){
    if (isset($_POST[$par])) { if(isset($_POST[$par]) and $_POST[$par]!='' ) $k=$_POST[$par];else $k=$def; update_option($par,$k);} 
}

/* Begin Filtering IPs */
if (get_option("exploitify_check_two")=='checked') add_action('admin_init', 'exploitify_ip_check');
if (get_option("exploitify_check_one")=='checked') add_action('template_redirect', 'exploitify_ip_check');
function exploitify_ip_check() {

    /* current ip address */
    $addr = $_SERVER['REMOTE_ADDR'];
    
    /* perform check */
    include('api.php');

    while (!feof($handle)) {
        /* Read in 1,000 byte chunks at a time */
  	$contents .= fread($handle, 1000);

        /* check if dirty */
  	if(strstr($contents, "has spam activity on")){
            header('HTTP/1.0 403 Forbidden');
            die("<center><div style='width:330px;background:#fafafa;border:1px solid #f7f7f7;padding-left:20px;padding-right:20px;padding-bottom:20px;text-align:justify'><center><h1>Access Denied!</h1></center>Your IP Address <b>$addr</b> has been blocked. If you feel you have received this message in error, then please contact the system administrator.<br /><br /><center><small style='color:red'>[ Reason: Possible botnet/spam attempts reported. ]</small></center></div></center>"); 
	} 

    }
	       
    fclose($handle);
		
}

/**
 * Check comment author email
 * Reference: https://codex.wordpress.org/Plugin_API/Filter_Reference/preprocess_comment
 **/
if (get_option("exploitify_check_three")=='checked') add_filter('preprocess_comment', 'exploitify_author_email');
function exploitify_author_email($commentdata) {

    /* current email */
    $addr = $commentdata['comment_author_email'];
	
    /* perform check */
    include('api.php');

    while (!feof($handle)) {
       /* Read in 1,000 byte chunks at a time */
  	$contents .= fread($handle, 1000);

        /* check if dirty */
        if(strstr($contents, "has spam activity on")){
            header('HTTP/1.0 403 Forbidden');
            die("<center><div style='width:330px;background:#fafafa;border:1px solid #f7f7f7;padding-left:20px;padding-right:20px;padding-bottom:20px;text-align:justify'><center><h1>Access Denied!</h1></center>Your email <b>$addr</b> has been blocked. If you feel you have received this message in error, then please contact the system administrator.<br /><br /><center><small style='color:red'>[ Reason: Possible botnet/spam attempts reported. ]</small></center></div></center>"); 
	} 

    }

    fclose($handle);	
    return $commentdata;

}

/* Check register email */
if (get_option("exploitify_check_four")=='checked') add_action( 'register_post', 'exploitify_reg_email', 10, 3 );
function exploitify_reg_email($user_login, $user_email, $errors) {

    /* current email */
    $addr = $user_email;
	
    /* perform check */
    include('api.php');

    while (!feof($handle)) {
       /* Read in 1,000 byte chunks at a time */
  	$contents .= fread($handle, 1000);

        /* check if dirty */
        if(strstr($contents, "has spam activity on")){
            header('HTTP/1.0 403 Forbidden');
            die("<center><div style='width:330px;background:#fafafa;border:1px solid #f7f7f7;padding-left:20px;padding-right:20px;padding-bottom:20px;text-align:justify'><center><h1>Access Denied!</h1></center>Your email <b>$addr</b> has been blocked. If you feel you have received this message in error, then please contact the system administrator.<br /><br /><center><small style='color:red'>[ Reason: Possible botnet/spam attempts reported. ]</small></center></div></center>"); 
	} 

    }

    fclose($handle);

}

/* Begin Filtering UserAgent */
if (get_option("exploitify_check_three")=='checked') add_action('admin_init', 'exploitify_useragent');
if (get_option("exploitify_check_five")=='checked') add_action('template_redirect', 'exploitify_useragent');
function exploitify_useragent() {

    /* current user-agent */
    $http_ua = $_SERVER['HTTP_USER_AGENT'];

    /* check if dirty */
    if ($http_ua == '') {
        header('HTTP/1.0 403 Forbidden');
        die("<center><div style='width:330px;background:#fafafa;border:1px solid #f7f7f7;padding-left:20px;padding-right:20px;padding-bottom:20px;text-align:justify'><center><h1>Access Denied!</h1></center>Your browser UserAgent is disabled. It must be enabled to continue. If you feel you have received this message in error, then please contact the system administrator.<br /><br /><center><small style='color:red'>[ Reason: Possible botnet/spam attempt. ]</small></center></div></center>"); 
    }

}
