<?php

/* Admin menu */
function exploitify_menu() {  
    add_menu_page('Exploitify', 'Exploitify', 'manage_options', 'exploitify', 'exploitify_panel', 'dashicons-shield', '99.9777');
    add_submenu_page('exploitify', 'Settings', 'Settings', 'manage_options', 'exploitify', 'exploitify_panel');
    add_submenu_page('exploitify', 'Status', 'Status', 'manage_options', 'api-status', 'exploitify_status');
}

/* Checkboxes */
function exploitify_is_checked($par){
    if (isset($_POST["exploitify_fs"])) { if(isset($_POST[$par])) $k='checked';else $k=''; update_option($par,$k);} 
}

/* Inputs */
function exploitify_string_setting($par,$def){
    if (isset($_POST[$par])) { if(isset($_POST[$par]) and $_POST[$par]!='' ) $k=$_POST[$par];else $k=$def; update_option($par,$k);} 
}

/* Begin Filtering IPs */
if (!isset($_SERVER["HTTP_CF_CONNECTING_IP"])) {
    if (get_option("exploitify_check_two")=='checked') add_action('admin_init', 'exploitify_ip_check');
}
if (get_option("exploitify_check_one")=='checked') add_action('template_redirect', 'exploitify_ip_check');
function exploitify_ip_check() {
    
    /* current ip address */
    $addr = $_SERVER['REMOTE_ADDR'];

    /* perform check */
    include('api.php');

    while (!@feof($handle)) {

        /* Read in 1,000 byte chunks at a time */
  	$contents = '';
  	$contents .= @fread($handle, 1000);

        /* check if dirty */
  	if(strstr($contents, "has spam activity on")){
            header('HTTP/1.0 403 Forbidden');
            $report = @fopen("http://exploitify.com/blacklist-data/ip.php?api=$EXPLOITIFY_API&key=$EXPLOITIFY_KEY@ip=$addr", "r"); 
            die("<center><div style='width:330px;background:#fafafa;border:1px solid #f7f7f7;padding-left:20px;padding-right:20px;padding-bottom:20px;text-align:justify'><center><h1>Access Denied!</h1></center>Your IP Address <b>$addr</b> has been blocked. If you feel you have received this message in error, then please contact the system administrator.<br /><br /><center><small style='color:red'>[ Reason: Possible botnet/spam attempts reported. ]</small></center></div></center>"); 
	} 

    }
	       
    fclose($handle);
		
}

/**
 * Check comment author email
 * Reference: https://codex.wordpress.org/Plugin_API/Filter_Reference/preprocess_comment
 **/
if (get_option("exploitify_check_three")=='checked') add_filter('preprocess_comment', 'exploitify_author_email');
function exploitify_author_email($commentdata) {

    /* current email */
    $addr = $commentdata['comment_author_email'];
	
    /* perform check */
    include('api.php');

    while (!@feof($handle)) {
       /* Read in 1,000 byte chunks at a time */
  	$contents = '';
  	$contents .= @fread($handle, 1000);

        /* check if dirty */
        if(strstr($contents, "has spam activity on")){
            header('HTTP/1.0 403 Forbidden');
            $report = @fopen("http://exploitify.com/blacklist-data/email.php?api=$EXPLOITIFY_API&key=$EXPLOITIFY_KEY&email=$addr", "r");
            die("<center><div style='width:330px;background:#fafafa;border:1px solid #f7f7f7;padding-left:20px;padding-right:20px;padding-bottom:20px;text-align:justify'><center><h1>Access Denied!</h1></center>Your email <b>$addr</b> has been blocked. If you feel you have received this message in error, then please contact the system administrator.<br /><br /><center><small style='color:red'>[ Reason: Possible botnet/spam attempts reported. ]</small></center></div></center>"); 
	} 

    }

    fclose($handle);	
    return $commentdata;

}

/* Check register email */
if (get_option("exploitify_check_four")=='checked') add_action( 'register_post', 'exploitify_reg_email', 10, 3 );
function exploitify_reg_email($user_login, $user_email, $errors) {

    /* current email */
    $addr = $user_email;
	
    /* perform check */
    include('api.php');

    while (!@feof($handle)) {
       /* Read in 1,000 byte chunks at a time */
  	$contents = '';
  	$contents .= @fread($handle, 1000);

        /* check if dirty */
        if(strstr($contents, "has spam activity on")){
            header('HTTP/1.0 403 Forbidden');
            $report = @fopen("http://exploitify.com/blacklist-data/email.php?api=$EXPLOITIFY_API&key=$EXPLOITIFY_KEY&email=$addr", "r");
            die("<center><div style='width:330px;background:#fafafa;border:1px solid #f7f7f7;padding-left:20px;padding-right:20px;padding-bottom:20px;text-align:justify'><center><h1>Access Denied!</h1></center>Your email <b>$addr</b> has been blocked. If you feel you have received this message in error, then please contact the system administrator.<br /><br /><center><small style='color:red'>[ Reason: Possible botnet/spam attempts reported. ]</small></center></div></center>"); 
	} 

    }

    fclose($handle);

}

/* Begin Filtering UserAgent */
if (!isset($_SERVER["HTTP_CF_CONNECTING_IP"])) {
    if (get_option("exploitify_check_three")=='checked') add_action('admin_init', 'exploitify_useragent');
}
if (get_option("exploitify_check_five")=='checked') add_action('template_redirect', 'exploitify_useragent');
function exploitify_useragent() {

    /* current user-agent */
    $http_ua = $_SERVER['HTTP_USER_AGENT'];

    /* check if dirty */
    if ($http_ua == '') {
        header('HTTP/1.0 403 Forbidden');
        die("<center><div style='width:330px;background:#fafafa;border:1px solid #f7f7f7;padding-left:20px;padding-right:20px;padding-bottom:20px;text-align:justify'><center><h1>Access Denied!</h1></center>Your browser UserAgent is disabled. It must be enabled to continue. If you feel you have received this message in error, then please contact the system administrator.<br /><br /><center><small style='color:red'>[ Reason: Possible botnet/spam attempt. ]</small></center></div></center>"); 
    }

}

/* Disable XML-RPC API */
if (get_option("exploitify_check_six")=='checked') add_filter( 'xmlrpc_enabled', '__return_false' );

/* Send email on successful login */
function exploitify_email_login($username) {
    
    date_default_timezone_set('America/New_York');
    $ip   = $_SERVER['REMOTE_ADDR'];
    $ua   = $_SERVER['HTTP_USER_AGENT'];
    $name = get_bloginfo( 'name' );
    $url  = get_bloginfo( 'wpurl' );
    $date = date('l jS \of F Y h:i:s A');    
    $subject = "Login Alert for $name";
    $user = get_user_by( 'login', $username );
    $to   = $user->user_email;
    if (function_exists('is_multisite') && is_multisite()) { 
        $admin_email = get_site_option( 'admin_email' );
        $headers = "From: admin <$admin_email>";
    } else {
        $admin_email = get_option('admin_email');
        //$headers = "From: admin <$admin_email>"; 
    }
    $one = "Your account was recently logged into from a device. Was this you? \n\n";
    $two = "Site URL:\n $url \n\n";
    $three = "Date/Time:\n $date (Eastern) \n\n";
    $four = "Username:\n $username \n\n";
    $five = "IP Address:\n $ip \n\n";
    $six = "User Agent:\n $ua \n\n";
    $seven = "If this was not you, please login to your account now and change your user password.\n";
    $eight = "$url/wp-admin/profile.php";
    $message = "$one $two $three $four $five $six $seven $eight";
    wp_mail($to, $subject, $message, $headers);
}

/* Login Notification */
if (get_option("exploitify_check_seven")=='checked') add_action('wp_login', 'exploitify_email_login');

/* Hide Login Errors */
if (get_option("exploitify_check_eight")=='checked') add_filter('login_errors', 'exploitify_login_errors');
function exploitify_login_errors() {
    return 'Incorrect login details.';
}

/* Check API Status */
function exploitify_api_check() {

    /* current ip address */
    $addr = "91.200.12.65";
    
    /* perform check */
    include('api.php');

    while (!@feof($handle)) {
        /* Read in 1,000 byte chunks at a time */
  	$contents = '';
  	$contents .= @fread($handle, 1000);

        /* check if dirty */
  	if(strstr($contents, "has spam activity on")){
            return "<span style='color:green'>OKAY</span>";
	} else {
	    return "<span style='color:red'>ERROR</span>";
	}

    }
	       
    fclose($handle);
		
}